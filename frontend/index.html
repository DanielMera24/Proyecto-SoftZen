<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoftZen - Yoga Terap√©utico Optimizado</title>
    
    <!-- Optimizaciones de rendimiento y SEO -->
    <meta name="description" content="SoftZen - Plataforma de yoga terap√©utico optimizada para instructores y pacientes. Rendimiento, sostenibilidad y escalabilidad.">
    <meta name="keywords" content="yoga, terap√©utico, instructores, pacientes, salud, bienestar">
    <meta name="author" content="SoftZen Team">
    <meta name="robots" content="index, follow">
    
    <!-- Preconnect para mejorar rendimiento -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://pagina-yoga.firebaseapp.com">
    <link rel="preconnect" href="https://firestore.googleapis.com">
    
    <!-- PWA Configuration Corregida -->
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SoftZen">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.svg">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon optimizado -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/icons/favicon-32x32.svg">
    
    <!-- Estilos optimizados -->
    <link rel="stylesheet" href="/styles.css">
    
    <!-- Firebase SDK v9 Compat (Carga optimizada y controlada) -->
    <script>
        // Control de carga de Firebase para evitar conflictos
        window.FIREBASE_LOAD_START = performance.now();
        console.log('üì¶ Iniciando carga controlada de Firebase SDK...');
    </script>
    
    <!-- Core Firebase (orden espec√≠fico para evitar problemas) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <!-- Performance monitoring de forma no bloqueante -->
    <script>
        // Cargar Performance de forma completamente opcional y segura
        (function() {
            try {
                const script = document.createElement('script');
                script.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-performance-compat.js';
                script.async = true;
                script.defer = true;
                script.onerror = function() {
                    console.warn('‚ö†Ô∏è Firebase Performance no disponible - posiblemente bloqueado por ad-blocker');
                };
                script.onload = function() {
                    console.log('üìä Firebase Performance cargado exitosamente');
                };
                document.head.appendChild(script);
            } catch (error) {
                console.warn('‚ö†Ô∏è Error cargando Firebase Performance:', error.message);
            }
        })();
        
        // Verificar carga completa de Firebase
        window.addEventListener('load', () => {
            const loadTime = performance.now() - window.FIREBASE_LOAD_START;
            console.log(`üì¶ Firebase SDK cargado en ${loadTime.toFixed(2)}ms`);
        });
    </script>
    
    <!-- Configuraci√≥n cr√≠tica inline para rendimiento -->
    <script>
        // Configuraci√≥n de rendimiento cr√≠tico mejorada
        window.SOFTZEN_PERFORMANCE = {
            startTime: performance.now(),
            criticalResourcesLoaded: false,
            firebaseReady: false,
            appReady: false
        };
        
        // Detectar dispositivo para optimizaciones
        window.SOFTZEN_DEVICE = {
            isMobile: /Mobi|Android/i.test(navigator.userAgent),
            isTablet: /Tablet|iPad/i.test(navigator.userAgent),
            isTouch: 'ontouchstart' in window,
            connection: navigator.connection?.effectiveType || 'unknown',
            memory: navigator.deviceMemory || 4,
            cores: navigator.hardwareConcurrency || 4
        };
        
        // Configuraci√≥n de lazy loading adaptativa
        window.SOFTZEN_LAZY_CONFIG = {
            rootMargin: window.SOFTZEN_DEVICE.isMobile ? '100px' : '50px',
            threshold: window.SOFTZEN_DEVICE.isMobile ? 0.05 : 0.1,
            enableLazyImages: true,
            enableLazyModules: !window.SOFTZEN_DEVICE.isMobile || window.SOFTZEN_DEVICE.memory >= 4
        };
        
        // Prevenir errores de inicializaci√≥n
        window.SOFTZEN_ERROR_COUNT = 0;
        window.SOFTZEN_MAX_ERRORS = 5;
        
        console.log('üöÄ SoftZen - Configuraci√≥n cr√≠tica cargada');
        console.log('üì± Dispositivo detectado:', window.SOFTZEN_DEVICE);
    </script>
</head>
<body>
    <!-- Loading Screen Optimizado y Funcional -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">üßò‚Äç‚ôÄÔ∏è</div>
            <h1 class="loading-title">SoftZen</h1>
            <p class="loading-subtitle">Yoga que transforma, cura y renueva</p>
            <div class="loading-spinner"></div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loadingProgressBar"></div>
            </div>
            <p class="loading-message" id="loadingMessage">Iniciando SoftZen...</p>
        </div>
    </div>

    <!-- Aplicaci√≥n Principal -->
    <div id="app" class="app" style="display: none;">
        <!-- Header Optimizado y Funcional -->
        <header class="header">
            <div class="header-container">
                <div class="header-brand">
                    <span class="header-logo">üßò‚Äç‚ôÄÔ∏è</span>
                    <h1 class="header-title">SoftZen</h1>
                </div>
                
                <nav class="header-nav" id="headerNav">
                    <div class="nav-user-info" id="navUserInfo" style="display: none;">
                        <span class="user-name" id="userDisplayName">Usuario</span>
                        <span class="user-role" id="userRole">Paciente</span>
                        <button class="btn-logout" id="btnLogout" type="button">
                            <span>Cerrar Sesi√≥n</span>
                        </button>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="main">
            <!-- Auth Container Completamente Funcional -->
            <div id="authContainer" class="auth-container">
                <div class="auth-card">
                    <div class="auth-header">
                        <div class="auth-logo">üßò‚Äç‚ôÄÔ∏è</div>
                        <h2 class="auth-title">SoftZen</h2>
                        <p class="auth-subtitle">Yoga que transforma, cura y renueva</p>
                    </div>

                    <!-- Tabs de Autenticaci√≥n -->
                    <div class="auth-tabs">
                        <button class="auth-tab active" data-tab="login" type="button">
                            <span>Iniciar Sesi√≥n</span>
                        </button>
                        <button class="auth-tab" data-tab="register" type="button">
                            <span>Registrarse</span>
                        </button>
                    </div>

                    <!-- Formulario de Login -->
                    <div id="loginForm" class="auth-form active">
                        <form id="loginFormElement" novalidate>
                            <div class="form-group">
                                <label for="loginEmail">Email</label>
                                <input 
                                    type="email" 
                                    id="loginEmail" 
                                    name="email" 
                                    required 
                                    placeholder="tu@email.com" 
                                    autocomplete="email"
                                    aria-describedby="loginEmailHelp"
                                >
                                <div id="loginEmailHelp" class="sr-only">Introduce tu direcci√≥n de email</div>
                            </div>

                            <div class="form-group">
                                <label for="loginPassword">Contrase√±a</label>
                                <div class="password-input">
                                    <input 
                                        type="password" 
                                        id="loginPassword" 
                                        name="password" 
                                        required 
                                        placeholder="Tu contrase√±a" 
                                        autocomplete="current-password"
                                        aria-describedby="loginPasswordHelp"
                                    >
                                    <button type="button" class="password-toggle" tabindex="-1" aria-label="Mostrar contrase√±a">
                                        <span class="show-text">üëÅÔ∏è</span>
                                        <span class="hide-text" style="display: none;">üôà</span>
                                    </button>
                                </div>
                                <div id="loginPasswordHelp" class="sr-only">Introduce tu contrase√±a</div>
                                <div class="password-forgot">
                                    <a href="#" id="forgotPasswordLink">¬øOlvidaste tu contrase√±a?</a>
                                </div>
                            </div>

                            <button type="submit" class="btn-primary auth-submit" id="btnLogin">
                                <span class="btn-text">Iniciar Sesi√≥n</span>
                                <span class="btn-loading" style="display: none;">
                                    <span class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>
                                    Iniciando...
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- Formulario de Registro -->
                    <div id="registerForm" class="auth-form">
                        <form id="registerFormElement" novalidate>
                            <div class="form-group">
                                <label for="registerName">Nombre Completo</label>
                                <input 
                                    type="text" 
                                    id="registerName" 
                                    name="name" 
                                    required 
                                    placeholder="Tu nombre completo" 
                                    autocomplete="name"
                                    aria-describedby="registerNameHelp"
                                >
                                <div id="registerNameHelp" class="sr-only">Introduce tu nombre completo</div>
                            </div>

                            <div class="form-group">
                                <label for="registerEmail">Email</label>
                                <input 
                                    type="email" 
                                    id="registerEmail" 
                                    name="email" 
                                    required 
                                    placeholder="tu@email.com" 
                                    autocomplete="email"
                                    aria-describedby="registerEmailHelp"
                                >
                                <div id="registerEmailHelp" class="sr-only">Introduce tu direcci√≥n de email</div>
                            </div>

                            <div class="form-group">
                                <label for="registerPassword">Contrase√±a</label>
                                <div class="password-input">
                                    <input 
                                        type="password" 
                                        id="registerPassword" 
                                        name="password" 
                                        required 
                                        placeholder="M√≠nimo 6 caracteres" 
                                        autocomplete="new-password"
                                        aria-describedby="registerPasswordHelp"
                                    >
                                    <button type="button" class="password-toggle" tabindex="-1" aria-label="Mostrar contrase√±a">
                                        <span class="show-text">üëÅÔ∏è</span>
                                        <span class="hide-text" style="display: none;">üôà</span>
                                    </button>
                                </div>
                                <div id="registerPasswordHelp" class="sr-only">M√≠nimo 6 caracteres</div>
                                <div class="password-strength" id="passwordStrength" style="display: none;"></div>
                            </div>

                            <div class="form-group">
                                <label for="registerRole">Tipo de Usuario</label>
                                <select id="registerRole" name="role" required aria-describedby="registerRoleHelp">
                                    <option value="">Selecciona tu rol</option>
                                    <option value="patient">Paciente</option>
                                    <option value="instructor">Instructor</option>
                                </select>
                                <div id="registerRoleHelp" class="sr-only">Selecciona si eres paciente o instructor</div>
                            </div>

                            <div class="form-group instructor-only" style="display: none;" id="instructorFields">
                                <label for="registerSpecialty">Especialidad</label>
                                <select id="registerSpecialty" name="specialty" aria-describedby="registerSpecialtyHelp">
                                    <option value="">Selecciona tu especialidad</option>
                                    <option value="hatha">Hatha Yoga</option>
                                    <option value="vinyasa">Vinyasa</option>
                                    <option value="therapeutic">Yoga Terap√©utico</option>
                                    <option value="yin">Yin Yoga</option>
                                    <option value="restorative">Yoga Restaurativo</option>
                                    <option value="meditation">Meditaci√≥n</option>
                                    <option value="breathing">T√©cnicas de Respiraci√≥n</option>
                                </select>
                                <div id="registerSpecialtyHelp" class="sr-only">Opcional: selecciona tu especialidad como instructor</div>
                            </div>

                            <button type="submit" class="btn-primary auth-submit" id="btnRegister">
                                <span class="btn-text">Registrarse</span>
                                <span class="btn-loading" style="display: none;">
                                    <span class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>
                                    Registrando...
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- Credenciales de Demo Mejoradas -->
                    <div class="auth-demo">
                        <h4>üéÆ Credenciales de Demostraci√≥n:</h4>
                        <div class="demo-credentials">
                            <div class="demo-credential">
                                <strong>üßë‚Äçüè´ Instructor:</strong><br>
                                <strong>Email:</strong> <code>admin@softzen.com</code><br>
                                <strong>Contrase√±a:</strong> <code>SoftZen2024!</code>
                            </div>
                            <div class="demo-credential">
                                <strong>üßò‚Äç‚ôÄÔ∏è Paciente:</strong><br>
                                <strong>Email:</strong> <code>paciente@softzen.com</code><br>
                                <strong>Contrase√±a:</strong> <code>SoftZen2024!</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Container Mejorado -->
            <div id="dashboardContainer" class="dashboard-container" style="display: none;">
                <div id="dashboard-content">
                    <!-- El contenido del dashboard se carga din√°micamente por JavaScript -->
                    <div class="dashboard-placeholder">
                        <div class="loading-spinner"></div>
                        <p>Cargando dashboard...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer Optimizado -->
        <footer class="footer">
            <div class="footer-container">
                <p class="footer-text">
                    ¬© 2025 SoftZen - Yoga Terap√©utico Optimizado | 
                    <span id="connectionStatus">üü¢ Online</span> |
                    <span id="performanceInfo">‚ö° Optimizado</span>
                </p>
            </div>
        </footer>
    </div>

    <!-- Notifications Container -->
    <div id="notifications-container" class="notifications-container" aria-live="polite"></div>

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator" style="display: none;" role="alert">
        <span>üîå Sin conexi√≥n - Trabajando offline</span>
    </div>

    <!-- Scripts Core (Critical Path) -->
    <script>
        // ===================================================================
        // SISTEMA DE CARGA COMPLETAMENTE OPTIMIZADO Y FUNCIONAL
        // ===================================================================
        
        window.SOFTZEN_LOADER = {
            progress: 0,
            stages: [
                'Iniciando sistema...',
                'Cargando Firebase...',
                'Configurando servicios...',
                'Verificando autenticaci√≥n...',
                'Preparando interfaz...',
                'Aplicando optimizaciones...',
                'Finalizando carga...'
            ],
            currentStage: 0,
            isCompleted: false,
            
            updateProgress(percentage, message) {
                this.progress = Math.min(100, Math.max(0, percentage));
                const progressBar = document.getElementById('loadingProgressBar');
                const messageEl = document.getElementById('loadingMessage');
                
                if (progressBar) {
                    progressBar.style.width = this.progress + '%';
                }
                
                if (messageEl && message) {
                    messageEl.textContent = message;
                }
                
                console.log(`üìä Carga: ${this.progress}% - ${message}`);
                
                // Actualizar performance tracking
                if (window.SOFTZEN_PERFORMANCE) {
                    window.SOFTZEN_PERFORMANCE.loadingProgress = this.progress;
                }
            },
            
            nextStage() {
                if (this.currentStage < this.stages.length - 1) {
                    this.currentStage++;
                    const percentage = ((this.currentStage + 1) / this.stages.length) * 100;
                    this.updateProgress(percentage, this.stages[this.currentStage]);
                    return true;
                }
                return false;
            },
            
            complete() {
                if (this.isCompleted) return;
                
                this.isCompleted = true;
                this.updateProgress(100, 'SoftZen listo');
                
                // Performance tracking
                if (window.SOFTZEN_PERFORMANCE) {
                    window.SOFTZEN_PERFORMANCE.loadCompleteTime = performance.now();
                    window.SOFTZEN_PERFORMANCE.totalLoadTime = 
                        window.SOFTZEN_PERFORMANCE.loadCompleteTime - window.SOFTZEN_PERFORMANCE.startTime;
                }
                
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loadingScreen');
                    const app = document.getElementById('app');
                    
                    if (loadingScreen && app) {
                        // Animaci√≥n suave de salida
                        loadingScreen.style.transition = 'opacity 0.5s ease-out';
                        loadingScreen.style.opacity = '0';
                        
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                            app.style.display = 'flex';
                            
                            // Fade in del app
                            app.style.opacity = '0';
                            app.style.transition = 'opacity 0.3s ease-in';
                            
                            requestAnimationFrame(() => {
                                app.style.opacity = '1';
                            });
                            
                            // Trigger de inicializaci√≥n de la app
                            window.dispatchEvent(new CustomEvent('appReady', {
                                detail: {
                                    loadTime: window.SOFTZEN_PERFORMANCE?.totalLoadTime,
                                    timestamp: new Date().toISOString()
                                }
                            }));
                            
                            console.log('üéâ SoftZen completamente cargado y listo');
                            
                        }, 500);
                    }
                }, 300);
            },
            
            // M√©todo para manejar errores durante la carga
            handleError(error, stage) {
                console.error(`‚ùå Error en etapa "${stage}":`, error);
                window.SOFTZEN_ERROR_COUNT = (window.SOFTZEN_ERROR_COUNT || 0) + 1;
                
                if (window.SOFTZEN_ERROR_COUNT > window.SOFTZEN_MAX_ERRORS) {
                    console.error('üö® Demasiados errores, activando modo de emergencia');
                    this.updateProgress(100, 'Activando modo de emergencia...');
                    this.complete();
                    return;
                }
                
                // Continuar con la siguiente etapa en caso de error no cr√≠tico
                this.updateProgress(this.progress + 10, `Error en ${stage}, continuando...`);
            }
        };
        
        // Inicializar progreso
        window.SOFTZEN_LOADER.updateProgress(10, 'Iniciando sistema...');
    </script>

    <!-- Firebase Configuration (Critical) -->
    <script type="module" src="/js/firebase-config.js"></script>
    
    <!-- Core Services -->
    <script type="module" src="/js/firebase-service.js"></script>
    <script type="module" src="/js/utils.js"></script>
    
    <!-- Application Core -->
    <script type="module" src="/app.js"></script>
    
    <!-- Diagnostic System -->
    <script src="/js/diagnostic.js"></script>
    
    <!-- System Verifier -->
    <script src="/js/system-verifier.js"></script>
    
    <!-- System Initializer (NUEVO) -->
    <script src="/js/system-initializer.js"></script>
    
    <!-- Enhanced Event Handlers -->
    <script>
        // ===================================================================
        // MANEJADORES DE EVENTOS MEJORADOS
        // ===================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM completamente cargado');
            
            // Configurar toggle de contrase√±as
            setupPasswordToggles();
            
            // Configurar tabs de autenticaci√≥n
            setupAuthTabs();
            
            // Configurar campos din√°micos
            setupDynamicFields();
            
            // Configurar validaci√≥n en tiempo real
            setupFormValidation();
        });
        
        function setupPasswordToggles() {
            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    const input = toggle.previousElementSibling;
                    const showText = toggle.querySelector('.show-text');
                    const hideText = toggle.querySelector('.hide-text');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        showText.style.display = 'none';
                        hideText.style.display = 'inline';
                        toggle.setAttribute('aria-label', 'Ocultar contrase√±a');
                    } else {
                        input.type = 'password';
                        showText.style.display = 'inline';
                        hideText.style.display = 'none';
                        toggle.setAttribute('aria-label', 'Mostrar contrase√±a');
                    }
                });
            });
        }
        
        function setupAuthTabs() {
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabType = tab.dataset.tab;
                    if (!tabType) return;
                    
                    // Actualizar tabs activos
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Mostrar formulario correspondiente
                    document.querySelectorAll('.auth-form').forEach(form => {
                        form.classList.toggle('active', form.id === `${tabType}Form`);
                    });
                    
                    // Focus en el primer input del formulario activo
                    const activeForm = document.querySelector('.auth-form.active');
                    if (activeForm) {
                        const firstInput = activeForm.querySelector('input');
                        if (firstInput) {
                            setTimeout(() => firstInput.focus(), 100);
                        }
                    }
                });
            });
        }
        
        function setupDynamicFields() {
            const roleSelect = document.getElementById('registerRole');
            const instructorFields = document.getElementById('instructorFields');
            
            if (roleSelect && instructorFields) {
                roleSelect.addEventListener('change', (e) => {
                    const isInstructor = e.target.value === 'instructor';
                    instructorFields.style.display = isInstructor ? 'block' : 'none';
                    
                    // Actualizar required del campo specialty
                    const specialtySelect = document.getElementById('registerSpecialty');
                    if (specialtySelect) {
                        specialtySelect.required = isInstructor;
                    }
                });
            }
        }
        
        function setupFormValidation() {
            // Validaci√≥n en tiempo real para passwords
            const passwordInputs = document.querySelectorAll('input[type="password"]');
            passwordInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    if (input.id === 'registerPassword') {
                        validatePasswordStrength(input);
                    }
                });
            });
            
            // Validaci√≥n de emails
            const emailInputs = document.querySelectorAll('input[type="email"]');
            emailInputs.forEach(input => {
                input.addEventListener('blur', (e) => {
                    validateEmail(input);
                });
            });
        }
        
        function validatePasswordStrength(input) {
            const strengthDiv = document.getElementById('passwordStrength');
            if (!strengthDiv) return;
            
            const password = input.value;
            const strength = calculatePasswordStrength(password);
            
            strengthDiv.style.display = password.length > 0 ? 'block' : 'none';
            strengthDiv.className = `password-strength ${strength.level}`;
            strengthDiv.innerHTML = `
                <div class="strength-text">Seguridad: ${strength.text}</div>
                <div class="strength-bar">
                    <div class="strength-fill ${strength.level}" style="width: ${strength.percentage}%"></div>
                </div>
            `;
        }
        
        function calculatePasswordStrength(password) {
            let score = 0;
            
            if (password.length >= 6) score += 1;
            if (password.length >= 8) score += 1;
            if (/[a-z]/.test(password)) score += 1;
            if (/[A-Z]/.test(password)) score += 1;
            if (/[0-9]/.test(password)) score += 1;
            if (/[^A-Za-z0-9]/.test(password)) score += 1;
            
            const levels = [
                { level: 'very-weak', text: 'Muy d√©bil', percentage: 10 },
                { level: 'weak', text: 'D√©bil', percentage: 25 },
                { level: 'fair', text: 'Regular', percentage: 50 },
                { level: 'good', text: 'Buena', percentage: 75 },
                { level: 'strong', text: 'Fuerte', percentage: 90 },
                { level: 'very-strong', text: 'Muy fuerte', percentage: 100 }
            ];
            
            return levels[Math.min(score, levels.length - 1)];
        }
        
        function validateEmail(input) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isValid = emailRegex.test(input.value);
            
            input.classList.toggle('error', !isValid && input.value.length > 0);
            
            return isValid;
        }
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ö†Ô∏è Service Worker no pudo registrarse:', error);
                    });
            });
        }
    </script>

    <!-- Performance Monitoring -->
    <script>
        // ===================================================================
        // MONITOREO DE RENDIMIENTO MEJORADO
        // ===================================================================
        
        window.addEventListener('load', () => {
            if ('performance' in window) {
                setTimeout(() => {
                    try {
                        const perfData = performance.getEntriesByType('navigation')[0];
                        const loadTime = perfData.loadEventEnd - perfData.fetchStart;
                        const domReady = perfData.domContentLoadedEventEnd - perfData.fetchStart;
                        const firstPaint = performance.getEntriesByType('paint').find(p => p.name === 'first-contentful-paint');
                        
                        const metrics = {
                            loadTime: `${loadTime.toFixed(1)}ms`,
                            domReady: `${domReady.toFixed(1)}ms`,
                            firstPaint: firstPaint ? `${firstPaint.startTime.toFixed(1)}ms` : 'N/A'
                        };
                        
                        console.log('üìä M√©tricas de rendimiento:', metrics);
                        
                        // Actualizar indicador de rendimiento
                        const perfInfo = document.getElementById('performanceInfo');
                        if (perfInfo) {
                            const indicator = loadTime < 2000 ? '‚ö° Excelente' : 
                                            loadTime < 4000 ? 'üöÄ Bueno' : 
                                            loadTime < 6000 ? '‚è±Ô∏è Aceptable' : 'üêå Lento';
                            perfInfo.textContent = indicator;
                        }
                        
                        // Almacenar m√©tricas para analytics
                        if (window.SOFTZEN_PERFORMANCE) {
                            window.SOFTZEN_PERFORMANCE.metrics = metrics;
                            window.SOFTZEN_PERFORMANCE.loadTime = loadTime;
                        }
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error calculando m√©tricas de rendimiento:', error);
                    }
                }, 1500);
            }
        });
        
        // Monitoreo de conexi√≥n mejorado
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            const offlineIndicator = document.getElementById('offlineIndicator');
            
            if (statusEl) {
                const statusConfig = {
                    online: { text: 'üü¢ Online', color: '#22c55e' },
                    offline: { text: 'üî¥ Offline', color: '#ef4444' },
                    slow: { text: 'üü° Conexi√≥n lenta', color: '#f59e0b' },
                    reconnecting: { text: 'üîÑ Reconectando', color: '#6b7280' }
                };
                
                const config = statusConfig[status] || statusConfig.offline;
                statusEl.textContent = config.text;
                statusEl.style.color = config.color;
            }
            
            if (offlineIndicator) {
                offlineIndicator.style.display = status === 'offline' ? 'block' : 'none';
            }
        }
        
        window.addEventListener('online', () => {
            updateConnectionStatus('online');
            console.log('üåê Conexi√≥n restaurada');
        });
        
        window.addEventListener('offline', () => {
            updateConnectionStatus('offline');
            console.log('üì± Trabajando offline');
        });
        
        // Detectar conexi√≥n lenta
        if ('connection' in navigator) {
            const connection = navigator.connection;
            
            function checkConnectionSpeed() {
                if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                    updateConnectionStatus('slow');
                } else if (navigator.onLine) {
                    updateConnectionStatus('online');
                }
            }
            
            connection.addEventListener('change', checkConnectionSpeed);
            checkConnectionSpeed();
        }
        
        // M√©tricas de memoria si est√°n disponibles
        if ('memory' in performance) {
            const logMemoryUsage = () => {
                const memory = performance.memory;
                const used = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                const total = Math.round(memory.totalJSHeapSize / 1024 / 1024);
                
                console.log(`üíæ Memoria: ${used}MB / ${total}MB`);
                
                // Advertir si el uso de memoria es alto
                if (used > 100) {
                    console.warn('‚ö†Ô∏è Alto uso de memoria detectado');
                }
            };
            
            // Log inicial y luego cada 5 minutos
            setTimeout(logMemoryUsage, 5000);
            setInterval(logMemoryUsage, 5 * 60 * 1000);
        }
    </script>
</body>
</html>